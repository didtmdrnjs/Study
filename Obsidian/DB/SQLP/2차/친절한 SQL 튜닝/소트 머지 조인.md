### SGA vs PGA

공유 메모리 영역인 SGA에 캐시된 데이터는 여러 프로세스가 공유할 수 있다.

- 하지만 동시에 액세스할 수는 없다.
- 동시에 액세스하려는 프로세스 간 액세스 직렬화하기 위한 Look 메커니즘으로서 래치가 존재한다.

데이터 블록과 인덱스 블록을 캐싱하는 DB 버퍼캐시는 SGA의 가장 핵심적인 구성 요소이며, 여기서 블록을 읽으려면 버퍼 Look도 얻어야 한다.

오라클 서버 프로세스는 SGA에 공유된 데이터를 읽고 쓰면서, 동시에 자신만이 고유 메모리 영역을 갖는데, 각 오라클 서버 프로세스에 할당된 메모리 영역을 PGA(Process/Program/Private Global Area)라고 한다.

- 프로세스에 종속적인 고유 데이터를 저장하는 용도로 사용한다.
- PGA 공간이 작아 데이터를 모두 저장할 수 없을 때는 Temp 테이블스페이스를 이용한다.
- 다른 프로세스와 공유하지 않는 독립적인 메모리 공간이므로 래치 메커니즘이 불필요하다.
    - 같은 양의 데이터를 읽더라도 SGA 버퍼캐시에서 읽을 때보다 훨씬 빠르다.

### 기본 메커니즘

아래 두 단계로 진행된다.

1. 소트 단계 : 양쪽 집합을 조인 컬럼 기준으로 정렬한다.
2. 머지 단계 : 정렬한 양쪽 집합을 서로 머지한다.

**동작 방식**

1. 조건에 해당하는 데이터를 읽어 조인 컬럼을 기준으로 정렬한다.
    - 정렬한 결과집합은 PGA 영역에 할당된 Sort Area에 저장한다.
2. PGA에 저장한 데이터를 스캔하면서 조인한다.
    - 데이터가 정렬되어 있으므로 조인 대상 레코드가 시작되는 시점과 종료되는 시점을 쉽게 알 수 있다.

Sort Area에 저장한 데이터 자체가 인덱스 역할을 하므로 인덱스가 필요하지 않다.

대량 데이터의 조인에 사용할 수 있다.

### 소트 머지 조인이 빠른 이유

소트 머지 조인은 Sort Area에 미리 정렬해 둔 자료구조를 이용한다는 점만 빼고 NL 조인과 프로세싱 자체는 같다.

**NL 조인과 소트머지 조인이 성능 차이가 나는 이유**

NL 조인은 인덱스를 이용한 조인 방식인다.

- 조인 과정에서 액세스하는 모든 블록을 랜덤 액세스 방식으로 건건이 DB 버퍼캐시를 경유해서 읽는다.
    - 인덱스든 테이블이든 읽는 모든 블록에 래치 획득 및 캐시버퍼 체인 스캔 과정을 거친다.
    - 버퍼캐시에서 읽지 못한 블록은 건건이 디스크에서 읽어 들인다.
- 인덱스를 이용하기 때문에 인덱스 손익분기점 한계를 그래도 드러낸다.

소트머지 조인은 양쪽 테이블로부터 조인 대상 집합을 일괄적으로 읽어 PGA에 저장한 후 조인한다.

- PGA는 프로세스만을 위한 독립적인 메모리 공간이므로 데이터를 읽을 때 래치 획득 과정이 없다.
    - 소트 머지 조인이 대량 데이터 조인에 유리한 이유다.
- 양쪽 테이블로부터 조인 대상 집합을 읽을 떄는 DB 버퍼캐시를 경유하는데 이때 인덱스를 이요하기도 한다.
    - 이때 생기는 버퍼캐시 탐색 비용과 랜덤 액세스 부하는 소트 머지 조인도 피할 수 없다.

### 소트 머지 조인의 주용도

소트 머지 조인은 다음 상황에서 주로 쓰인다.

- 조인 조건식이 등치(=) 조건이 아닌 대량 데이터 조인
- 조인 조건식이 아예 없는 조인(Cross Join, 카테시안 곱)

### 소트 머지 조인 제어하기

실행 계획은 다음과 같다.

```sql
Execution Plan
--------------------------------
0    SELECT STATEMENT Optimizer=ALL_ROWS
1 0    MERGE JOIN
2 1      SORT (JOIN)
3 2        TABLE ACCESS (BY INDEX ROWID) OF 테이블1 (TABLE)
4 3          INDEX (RANGE SCAN) OF 인덱스1 (INDEX)
5 1      SORT (JOIN)
6 5        TABLE ACCESS (BY INDEX ROWID) OF 테이블2 (TABLE)
7 6          INDEX (RANGE SCAN) OF 인덱스2 (INDEX)
```

소트 머지 조인은 use_merge 힌트로 유도한다.