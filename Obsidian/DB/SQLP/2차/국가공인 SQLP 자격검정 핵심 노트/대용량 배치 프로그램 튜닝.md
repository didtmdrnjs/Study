**배치 프로그램**

DW/OLAP 시스템뿐만 아니라 OLTP(온라인 트랜잭션 처리) 시스템에서도 많이 활용한다.

실시간에 가까운(Near Real Time) 정보 서비스 요구가 늘면서 On-Demand 배치가 늘고, 트랜잭션을 일정량 모았다가 지연(deferred) 처리하는 배치 프로그램의 활용도 느는 추세다.

**배치 프로그램 튜닝**

배치 프로그램은 항상 전체 처리속도 최적화에 목표를 두고 튜닝해야 한다.

- 개별 서비스 또는 프로그램을 가장 빠른 속도로 최적화하더라도 전체 배치 프로그램 수행시간을 단축하지 못하면 무의미하다. 튜닝 대상을 선정할 때도 이런 기준을 갖고 선별해야 한다.
- 자원에 대한 경합이 극심한 상황에선 프로그램들이 정상적으로 진행하기 어렵다.
    - 따라서 병렬도(DOP)를 32로 지정해서 4분이 소요되는 프로그램을 병렬 처리 없이 10분이 소요되도록 하는 것이 오히려 나을 수 있다.
    - 시스템 자원을 독점적으로 사용하도록 설정된 프로그램을 찾아 병렬도를 제한하고, 동시에 수행되는 프로그램 개수도 적절히 유지해야 한다.
- 같은 시각에 수많은 프로그램이 집중적으로 수행되면 자원(CPU, Memory, Disk 등)과 Lock(Latch와 같은 내부 Lock까지 포함)에 대한 심한 경합이 발생한다.
    - 그러면 프로세스가 실제 일한 시간보다 대기하는 시간이 더 많아지므로 총 수행시간이 늘어난다.
    - 그럴 때 배치 윈도우(Batch Window)를 적절히 조절하는 것만으로 배치 프로그램 수십 개를 튜닝한 것과 같은 효과를 내기도 한다.

**배치 프로그램 대별**

- 절차형으로 작성된 프로그램
- One SQL 위주로 작성된 프로그램

**Intra-Operation Parallelism**

병렬 처리에서 서로 배타적인 범위를 독립적으로 동시에 처리하는 것이다.

**Inter-Operation Parallelism**

서버집합에 속한 프로세스들이 읽은 데이터를 반대편 서버집합(또는 QC)에 전송하는 작업을 병렬로 동시에 진행하는 것이다.

**P→P(PARALLEL_TO_PARALLEL) 오퍼레이션**

데이터를 재분해(redistribution)하는 오퍼레이션이다.

- 실행계획에 P→P 오퍼레이션이 나타나는 구간은 두개의 서버 집합(Server Set)이 처리한다. 따라서 사용자가 지정한 병렬도의 2배수만큼 병렬 프로세스가 필요하다.
- 데이터 재분배 과정에 테이블 큐(Queue)를 사용한다.
- 데이터를 정렬(order by) 또는 그룹핑(group by)하거나 조인을 위해 동적으로 파티셔닝할 때 사용되며, 첫 번째 병렬 서버 집합이 읽거나 가공한 데이터를 두 번째 병렬 서버 집합에 전송하는 과정에서 병렬 프로세스 간 통신이 발생하므로 Inter-Operation Parallelism에 속한다.

**IN-OUT 오퍼레이션**

- PARALLEL_FROM_SERIAL(S→P) : QC가 읽은 데이터를 테이블 큐를 통해 병렬 서버 프로세스에게 전송
- PARALLEL_TO_SERIAL(P→S) : 각 병렬 서버 프로세스가 처리한 데이터를 QC에게 전송
- PARALLEL_TO_PARALLEL(P→S) : 한 서버 집합(Server Set)이 반대편 서버 집합에 데이터를 전송
- PARALLEL_COMBINED_WITH_PARENT(PCWP) : 한 병렬 프로세스가 현재 스텝과 부모 스텝을 모두 처리
- PARALLEL_COMBINED_WITH_CHILD(PCWC) : 한 병렬 프로세스가 현재 스텝과 자식 스텝을 모두 처리

**Granule**

데이터를 병렬로 처리할 때 일의 최소 단위이다.

- 블록 기반
    - QC가 테이블로부터 읽어야 할 일정 범위(Range)의 블록을 각 병렬 프로세스에게 할당한다.
    - 병렬 프로세스가 한 Granule에 대한 일을 끝마치면 이어서 다른 Granule을 할당한다. 따라서 프로세스 간 처리량에 편차가 거의 발생하지 않는다.
    - 파티션 여부, 파티션 개수와 무관하게 병렬도를 지정할 수 있다.
- 파티션 기반
    - 한 파티션에 대한 작업을 한 프로세스가 모두 처리하며, 아래와 같은 작업을 수행할 때 사용된다.
        - Partition-Wise 조인 시
        - 파티션 인덱스를 병렬로 스캔할 때(Index Range Scan, Index Full Scan)
        - 파티션 인덱스를 병렬로 갱신할 때
        - 파티션 테이블 또는 파티션 인덱스를 병렬로 생성할 때

한 파티션을 두 개 프로세스가 함께 처리할 수 없으므로 병렬도를 파티션 개수보다 크게 지정하면 서버 리소스를 낭비하게 된다.

병렬도를 파티션 개수 이하로 지정할 때는 블록 기반 Granule과 마찬가지로 먼저 일을 마친 프로세스에게 다음 파티션을 할당한다.

더 처리할 파티션이 없을 때 먼저 일을 끝마친 프로세스는 다른 프로세스가 일을 마칠 때까지 기다리게 되므로 파티션간 데이터양에 편차가 심할 때 리소스를 낭비하게 된다.

**병렬 SQL 튜닝**

- 병렬 프로세스간 통신량을 최소화한다.
- 데이터를 병렬로 처리하는 중에 생기는 병목 구간을 해소한다.
- 성능 향상 효과를 체감할 수 있는 최소한의 병렬 프로세스를 할당한다.
- 체크해야 할 항목
    - 병렬로 처리하는 중간 단계에 PARALLEL_TO_SERIAL 오퍼레이션이 나타나면 병목 구간으로 작용한다.
    - 병렬로 처리하는 과정에 큰 테이블을 단일 프로세스로 읽으면 병목 구간이 될 수 있다. 작은 테이블은 단일 프로세스로 읽어도 성능에 큰 영항을 주지 않는다.
    - 대형 테이블을 Broadcast 방식으로 분배하면 프로세스 간 통신에 따른 부담이 클 뿐만 아니라 읽은 데이터를 프로세스 개수만큼 복제하는 결과를 초래하므로 메모리와 디스크 자원을 많이 사용한다.