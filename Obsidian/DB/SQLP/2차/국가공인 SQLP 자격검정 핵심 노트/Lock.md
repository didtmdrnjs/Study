**Lock**

Lock 경합은 최소화해야 하지만, Lock 자체는 DML을 수행하는 과정에 당연히 나타나는 자연스러운 현상이다.

Lock 점유시간이 길면 Lock 경합이 발생할 가능성이 높아지므로 튜닝 대상인지 점검할 필요가 있다.

교착상태가 발생하면, DBMS가 둘 중 한 세션에 에러를 발생시킴으로써 교착 상태를 해소한다.

SQL 튜닝을 통해 I/O를 줄임으로써 수행 시간을 단축하면, Lock 점유 시간이 줄면서 Lock 경합과 교착상태 발생 가능성도 줄어든다.

**Lock과 트랜젝션에 대한 설명**

원자성(Atomicity)을 훼손하지 않는 범위에서 트랜잭션은 가능한 짧게 정의하는 것이 좋다.

온라인 트랜젝션을 처리하는 프로그램에 SELECT FOR UPDATE 문을 나중에 변경할 목적으로 쓸 수 있다.

공유 Lock과 배타적 Lock은 서로 호환되지 않으므로 블로킹이 발생한다.

온라인 트랜잭션에서 자주 변경하는 데이터를 배치(Batch) 프로그램이 동시에 변경하지 않도록 프로글매을 설계하거나 시간대를 조절하는 것이 좋다.

**Lock Escalation**

이다.로우 레벨 Lock이 페이지, 익스텐트, 테이블 레벨 Lock으로 점점 확장되는 것

Lock 매니저로 Lock을 관리하는 DBMS에서 메모리 자원의 한계를 극복하기 위해 구현된 기능이다.

낮은 레벨의 Lock을 사용할수록 동시성이 좋지만, 관리해야 할 Lock 개수가 증가하므로 더 많은 메모리 자원을 소비한다.

반대로, 높은 레벨의 Lock을 사용할수록 더 적은 메모리 자원을 사용하지만, 하나의 Lock으로 수많은 레코드를 한꺼번에 잠그기 때문에 동시성은 나빠진다.

참고로, 오라클은 Lock을 로우 자체의 속성으로 관리하므로 Lock Escalation은 절대 발생하지 않는다.

**배타락**

모든 DBMS가 DML 수행 시 배타적 Lock을 사용한다. 배타적 Lock끼리는 호환되지 않으므로 서로 블로킹한다.

3번처럼 서로 다른 컬럼을 Update를 하더라도 Lock 경합을 피할 수 없다.

- Row 단위 Lock을 사용하기 때문이다.

**Lock 호환성**

모든 DBMS가 DML 수행 시 배타적 Lock을 사용한다.

배타적 Lock끼리는 호환되지 않으므로 서로 블로킹한다.

- SQL Server는 SELECT 문으로 데이터를 읽을 떄 공유 Lock을 사용한다.
    
- 공유 Lock끼리는 호환되므로 서로 블로킹 하지 않지만, 공유 Lock은 배타적 Lock과 호환되지 않으므로 서로 블로킹한다.
    
- MVCC 모델을 사용하는 오라클은 SELECT문 수행 시 어떤 Lock도 사용하지 않는다.
    
- 따라서 DML이 수행 중인 데이터를 어떤 간섭도 받지 않고 읽을 수 있다.
    
- 다른 트랜잭션이 읽고 있는 데이터를 변경할 때도 블로킹은 발생하지 않는다.
    

**오라클 Lock**

- (FOR UPDATE를 사용하지 않는 한) SELECT와 DML은 서로 진행을 방해하지 않는다.
- 다른 트랜잭션이 변경 중인 레코드를 삭제할 수 없다.
- 다른 트랜잭션이 변경 중인 레코드를 읽고자 할 때 기다리지 않지만, 변경중인 값을 읽지는 않는다.
- 오라클에서는 Lock Escalation이 발생하지 않는다.

**SQL Server Lock**

- 다른 트랜잭션이 변경 중인 레코드를 읽으려면 커밋할 때까지 기다려야 한다.
- 다른 트랜잭션이 조회중인 레코드를 변경하려면 다음 레코드로 이동할 때까지만 기다리면 된다.
- 다른 드랜잭션이 조회 중인 레코드를 읽을 때는 기다리지 않아도 된다.
- 변경하는 데이터가 많아지면 Lock Escalation이 발생한다.

**INSERT**

- 테이블에 Unique 인덱스나 제약이 없으면, INSERT끼리는 서로 블로킹하지 않는다.
- 테이블에 Unique 인덱스나 제약이 설정돼 있으면, 같은 값을 동시에 INSERT 하지 못한다.
- 후행 트랜잭션은 기다렸다가 선행 트랜잭션이 커밋하면 Unique 제약 위반 에러가 발생하고, 롤백하면 INSERT를 진행한다.
- INSERT 중인 데이터를 다른 트랜잭션이 읽거나 변경하거나 삭제하는 작업은 인덱스나 제약 유무에 상관없이 불가능하다.