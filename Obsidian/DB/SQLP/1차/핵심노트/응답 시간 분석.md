**대기 이벤트**

- 프로세스가 공유 메모리의 버퍼캐시, 라이브러리 캐시에서 정보를 읽으려면 래치를 반드시 획득해야 하는데 래치를 획들하는 과정에서 경합이 발생하면대기 이벤트가 나타나지만 경합없이 바로 읽으면 대기 이벤트가 나타나지 않는다.
- 대기 이벤트는 프로세스가 CPU를 OS에 반환하고 수면(Sleep) 상태로 진입하는 원인을 기록하기 위해 개발 되었다.

**대기 이벤트가 발생하는 원인**

- 프로세스가 필요로 하는 특정 리소스가 다른 프로세스에 의해 사용 중일 때.
- 다른 프로세스에게 작업을 요청하고 해당 작업이 완료되기를 기다릴 때.
- 프로세스가 할 일이 없을 때.

**대기 이벤트가 발생하는 대표적인 예시**

- SGA 공유 메모리에서 특정 자원을 액세스하려고 래치를 획득하는 과정에서 다른 프로세스와 **경합**이 발생.
- 디스크로부터 블록 I/O를 요청.
- 클라이언트로부터 다음 작업 요청이 오기를 기다리는 경우.

**대기 이벤트 종류**

- latch: shared pool : Shared Pool에서 특정 오브젝트 정보 또는 SQL 커서를 위한 Free Chunk를 할당받으려 할 때 shared pool 래치를 할당받아야하는데, 이 대기 이벤트는 **shared pool 래치를 할당받는 과정**에 발생하는 **경합**과 관련 있으며, **하드 파싱**을 동시에 심하게 일으킬 때 주로 일어남.
- library cache lock, library cache pin : 주로 SQL 수행 도중 **DDL**을 수행 할 때 나타남.
- free buffer waits : **서버 프로세스**가 **버퍼 캐시에서 Free Buffer**를 찾지 못해 **DBWR**에게 **공간을 확보**해 달라고 신호를 보낸 후 대기할 때 나타남.
- log file sync : **커밋 명령**을 전송받은 서버 프로세스가 **LGWR**에게 **로그 버퍼**를 로그 파일에 **기록**해 달라고 신호를 보낸 후 대기할 때 나타남.

**성능관리 방법론**

- 대기 이벤트를 기반으로 세션 또는 시스템 전체에 발생하는 병목 현상과 그 원인을 찾아 문제를 해결하는 방법, 과정을 ‘대기 이벤트(Wait Event) 기반’ 또는 ‘응답 시간 분석(Response Time Analysis)’ 성능관리 방법론 이라함.

**Response Time Analysis 성능관리 방법론**

- 세션 또는 시스템 전체에 발생하는 병목 현상과 그 원인을 찾아 문제를 해결하는 방법과 과정을 다루며, 데이터베이스 서버의 응답 시간을 아래와 같이 정의한다.

$$ Response Time = Service Time(CPU Time) + Wait Time(Queue Time) $$

- 서비스 시간(Services Time, CPU Time)은 프로세스가 정상적으로 동작하명 일을 수행한 시간을 의미하고, 대기 시간(Wait Time, Queue Time)은 CPU를 OS에 반환하고 수면(Sleep) 상태에서 대기한 시간을 의미한다.

**AWR(Automatic Workload Repository)**

- 전통적으로 사용하던 Ratio 기반 성능 분석 방법론에 응답 시간 분석 방법론을 더해 Statspack을 개발하였고, 이을 확장 및 업그레이드해서 만든 것이 AWR이다.
- AWR 보고서를 활용해 성능 이슈를 해결하려면 peak 시간대 또는 장애 발생 시점을 전후해 가능한 한 짧은 스냅샷 구간을 선택해야 한다. 특정 시점에 시스템에 큰 부하가 발행했어도 하루 또는 일주일 보고서로 출력해서 보면 초당 부하 발생량과 대기 시간에 전혀 문제가 없는 것처럼 평균 수치가 나타난다. 사용자 인터뷰를 통해 성능 저하 현상을 경험했던 시간대를 파악하거나 sar, topas, vmstat, osstat 등 OS 모니터링 도구를 이용해 CPU, 메모리, I/O 사용량 정보를 수집하고 이를 통해 peak 시간대를 파악할 수 있다.
- 과거에 사용하던 Statspack은 SQL로 딕셔너리를 조회해서 성능 정보를 수집했기 때문에 그 자체가 시스템에 부하를 주는 요소로 작용했고, 따라서 스냅샷 주기를 짧게 설정하기가 곤란했다. 반면 AWR은 뷰를 조회하지 않고 DMA(Direct Memory Access) 방식으로 SGA 공유 메모리를 직접 액세스해서 성능 정보를 수집하기 때문에 좀 더 빠르게 정보를 수집할 수 있다. 부하가 적기 때문에 Statspack보다 더 자주 더 많은 정보를 수집할 수 있게 되었다.
- AWR 보고서에 출력되는 항목들은 ‘dba_hist_’로 시작하는 각종 뷰를 이용해 사용자가 직접 조회할 수도 있다.

**AWR 보고서**

- 캐시 크기(Cache Sizes)
- 부하 프로파일(Load Profile)
- 인스턴스 효율성(Instance Efficiency)
- 최상위 대기 이벤트(Top N Events)
- Shared Pool 통계(Shared Pool Statistics)
- IO 프로파일(IO Profile)
- 메모리 통계(Memory Statistics)

**SQL 파싱과 관련된 인스턴스 효율성 항목들**

- Soft Parse % : 실행계획이 라이브러리 캐시에서 찾아져 하드파싱을 일으키지 않고 SQL을 수행한 비율이다. (구하는 공식은 (전체 Parse Call 횟수 - 하드파싱 횟수) / (전체 Parse Call 횟수) * 100 이다)
- Execute to Parse % : Parse Call 없이 곧바로 SQL을 수행한 비율, 즉 커서를 애플리케이션에서 캐싱한 채 반복 수행한 비율.
- Parse CPU to Parse Elapsd % : 파싱 총 소요 시간 중 CPU time이 차지한 비율이다. 파싱에 소요된 시간 중 실제 일을 수행한 시간 비율을 말하며, 이 값이 낮다면 파싱 도중 대기가 많이 발생했음을 의미한다.

**ASH(Active Session History)**

- 시스템에 문제가 생겼을 때 Ratio 기반 분석 방법으로 원인을 찾아 문제를 해결하려면 많은 시간이 걸린다. 대기 이벤트 기반 분석 방법론을 사용해도 마찬가지다. 대기 이벤트 분석을 통해 문제의 원인을 금방 알 수는 있지만, 실제 문제를 해결하려면 구체적으로 어떤 프로그램, 어떤 세션에서 성능 문제를 야기했는지 확인할 수 있어야 한다.
- 실시간 모니터링을 통해 문제를 빠르게 해결하려면 세션 레벨 성능 분석이 필요한데, 오라클 9i까지 제공하던 세션 레벨 동적 뷰만으로는 한계가 많았다. SQL 트레이스를 통해 가장 상세한 세션 레벨 분석이 가능하지만, 시스템에 주는 부하가 크고, 파일 단위로 정보가 수집되기 때문에 통계적 접근이 어려우며, 분석을 완료하는 데까지 시간이 오래 걸린다. 게다가 수동으로 활성화해야 해서 SQL 트레이스를 걸어 확인하려는 순간 이미 상황이 종료돼 버리는 경험을 DB관리자라면 누구나 했을 것이다. 문제가 발생하기 직전 상황에 대한 분석은 아예 불가능하다. DB성능 관리상의 이런 어려움을 해소하기 위해 오라클 10g에서 ASH 기능을 도입했다.
- 오라클은 현재 접속해서 활동 중인 Active 세션 정보를 1초에 한 번씩 샘플링해서 ASH 버퍼에 저장한다. SGA Shared Pool에서 CPU당 2MB의 버퍼를 할당받아 세션 정보를 기록하며, 1 시간 혹은 버퍼의 2/3가 찰 때마다 디스크에 기록한다. 즉, AWR에 저장하는 것이다.
- ASH 버퍼에 저장된 세션 히스토리 정보는 v$active_session_history 뷰를 통해 조회할 수 있다. ASH 기능을 이용하면 현재뿐 아니라 과거 시점에 발행한 장애 및 성능 저하 원인까지 세션 레벨로 분석할 수 있게 도와준다. AWR로 옮겨진 좀 더 오래된 과거의 세션 히스토리 정보는 dba_hist_active_sess_history 뷰를 통해 조회할 수 있다.

**동적 성능 뷰**

- v$session_wait : 이 뷰를 통해 문제의 대기 이벤트를 가장 많이 발생시키는 세션 목록을 확인할 수 있다.
- v$active_session_history : 이 뷰를 통해 문제의 세션들이 어떤 SQL을 수행하고 있는지 확인할 수 있다.
- v$sql : 이 뷰를 통해 문제 SQL의 전체 문장과 수행 통계(실행횟수, 평균 소요시간, 평균 블록 I/O 등)를 확인할 수 있다.
- dba_hist_active_sess_history : AWR로 옮겨진 오래된 과거의 세션 히스토리 정보를 확인할 수 있다.